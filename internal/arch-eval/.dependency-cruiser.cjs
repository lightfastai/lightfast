/** @type {import('dependency-cruiser').IConfiguration} */
module.exports = {
  options: {
    doNotFollow: { path: "node_modules" },
    tsPreCompilationDeps: false,
    combinedDependencies: true,
    enhancedResolveOptions: {
      exportsFields: ["exports"],
      conditionNames: ["import", "require", "node", "default"],
    },
  },
  forbidden: [
    // === LAYER RULES ===
    {
      name: "no-app-to-app-imports",
      comment: "Apps must not import from other apps",
      severity: "error",
      from: { path: "^apps/([^/]+)/" },
      to: { path: "^apps/(?!$1)([^/]+)/" },
    },
    {
      name: "no-package-to-app-imports",
      comment: "Packages must not import from apps",
      severity: "error",
      from: { path: "^packages/" },
      to: { path: "^apps/" },
    },
    {
      name: "no-vendor-to-package-imports",
      comment: "Vendor abstractions must not import from packages",
      severity: "error",
      from: { path: "^vendor/" },
      to: { path: "^packages/" },
    },
    {
      name: "no-vendor-to-api-imports",
      comment: "Vendor abstractions must not import from API layer",
      severity: "error",
      from: { path: "^vendor/" },
      to: { path: "^api/" },
    },
    {
      name: "no-package-to-api-imports",
      comment: "Packages must not import from API layer (reverse dependency)",
      severity: "error",
      from: { path: "^packages/" },
      to: { path: "^api/" },
    },
    {
      name: "no-app-to-db-imports",
      comment: "Apps must not import from DB directly (go through API)",
      severity: "error",
      from: { path: "^apps/" },
      to: { path: "^db/" },
    },
    {
      name: "no-circular-packages",
      comment: "No circular dependencies between workspace packages",
      severity: "error",
      from: {},
      to: { circular: true },
    },

    // === VENDOR ABSTRACTION ENFORCEMENT ===
    // Each rule ensures third-party SDKs are only imported within their vendor wrapper package
    {
      name: "vendor-only-planetscale",
      comment: "Use @vendor/db instead of @planetscale/* directly",
      severity: "error",
      from: { pathNot: "^vendor/db/" },
      to: { path: "^@planetscale" },
    },
    {
      name: "vendor-only-clerk",
      comment: "Use @vendor/clerk instead of @clerk/* directly",
      severity: "error",
      from: { pathNot: "^vendor/clerk/" },
      to: { path: "^@clerk" },
    },
    {
      name: "vendor-only-upstash",
      comment: "Use @vendor/upstash instead of @upstash/redis directly",
      severity: "error",
      from: { pathNot: "^vendor/upstash/" },
      to: { path: "^@upstash/redis" },
    },
    {
      name: "vendor-only-upstash-workflow",
      comment: "Use @vendor/upstash-workflow instead of @upstash/workflow directly",
      severity: "error",
      from: { pathNot: "^vendor/upstash-workflow/" },
      to: { path: "^@upstash/workflow" },
    },
    {
      name: "vendor-only-inngest",
      comment: "Use @vendor/inngest instead of inngest directly",
      severity: "error",
      from: { pathNot: "^vendor/inngest/" },
      to: { path: "^inngest$" },
    },
    {
      name: "vendor-only-inngest-packages",
      comment: "Use @vendor/inngest instead of @inngest/* directly",
      severity: "error",
      from: { pathNot: "^vendor/inngest/" },
      to: { path: "^@inngest" },
    },
    {
      name: "vendor-only-sentry",
      comment: "Use @vendor/observability or @vendor/next instead of @sentry/* directly",
      severity: "error",
      from: { pathNot: "^vendor/(observability|next)/" },
      to: { path: "^@sentry" },
    },
    {
      name: "vendor-only-logtail",
      comment: "Use @vendor/observability or @vendor/next instead of @logtail/* directly",
      severity: "error",
      from: { pathNot: "^vendor/(observability|next)/" },
      to: { path: "^@logtail" },
    },
    {
      name: "vendor-only-pinecone",
      comment: "Use @vendor/pinecone instead of @pinecone-database/* directly",
      severity: "error",
      from: { pathNot: "^vendor/pinecone/" },
      to: { path: "^@pinecone-database" },
    },
    {
      name: "vendor-only-resend",
      comment: "Use @vendor/email instead of resend directly",
      severity: "error",
      from: { pathNot: "^vendor/email/" },
      to: { path: "^resend$" },
    },
    {
      name: "vendor-only-posthog",
      comment: "Use @vendor/analytics instead of posthog-* directly",
      severity: "error",
      from: { pathNot: "^vendor/analytics/" },
      to: { path: "^posthog" },
    },
    {
      name: "vendor-only-knocklabs",
      comment: "Use @vendor/knock instead of @knocklabs/* directly",
      severity: "error",
      from: { pathNot: "^vendor/knock/" },
      to: { path: "^@knocklabs" },
    },
    {
      name: "vendor-only-basehub",
      comment: "Use @vendor/cms instead of basehub directly",
      severity: "error",
      from: { pathNot: "^vendor/cms/" },
      to: { path: "^basehub$" },
    },
    {
      name: "vendor-only-arcjet",
      comment: "Use @vendor/security instead of @arcjet/* directly",
      severity: "error",
      from: { pathNot: "^vendor/security/" },
      to: { path: "^@arcjet" },
    },
    {
      name: "vendor-only-nosecone",
      comment: "Use @vendor/security instead of @nosecone/* or nosecone directly",
      severity: "error",
      from: { pathNot: "^vendor/security/" },
      to: { path: "^@?nosecone" },
    },
    {
      name: "vendor-only-mastra",
      comment: "Use @vendor/mastra instead of @mastra/* directly",
      severity: "error",
      from: { pathNot: "^vendor/mastra/" },
      to: { path: "^@mastra" },
    },
    {
      name: "vendor-only-cohere",
      comment: "Use @vendor/embed instead of cohere-ai directly",
      severity: "error",
      from: { pathNot: "^vendor/embed/" },
      to: { path: "^cohere-ai" },
    },
    {
      name: "vendor-only-vercel-blob",
      comment: "Use @vendor/storage instead of @vercel/blob directly",
      severity: "error",
      from: { pathNot: "^vendor/storage/" },
      to: { path: "^@vercel/blob" },
    },

    // === DOMAIN SCOPE RULES ===
    {
      name: "console-packages-domain-boundary",
      comment: "@repo/console-* packages should not be imported by non-console apps",
      severity: "warn",
      from: { path: "^apps/(?!console)" },
      to: { path: "@repo/console-" },
    },
  ],
};
