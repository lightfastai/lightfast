# Full End-to-End Schema-Documentation Synchronization Plan

## Overview

Eliminate documentation drift between Zod schemas (`@repo/console-types`) and the SDK/MCP documentation MDX files. Currently, parameter tables, response schemas, and type definitions in `typescript-sdk.mdx` and `mcp-server.mdx` are manually maintained and have **critical drift** from actual schemas. This plan creates OpenAPI-powered MDX components that auto-render accurate parameter tables at build time, while preserving human-written narrative guides.

## Current State Analysis

### Critical Drift Issues Found

| Issue | Location | Docs Say | Schema Says |
|-------|----------|----------|-------------|
| Search mode values | SDK + MCP | `"quality"` | `"thorough"` |
| Filter field name | SDK + MCP | `sources` | `sourceTypes` |
| Filter dateRange type | SDK + MCP | `string` (e.g. `"30d"`) | `object` with `start`/`end` ISO datetimes |
| Missing filter fields | SDK + MCP | - | `observationTypes`, `actorNames` |
| Search response array | SDK + MCP | `results` | `data` |
| FindSimilar response array | SDK + MCP | `results` | `similar` |
| ContentItem.content | SDK + MCP | required | optional |
| ContentItem.title | SDK + MCP | required string | nullable string |
| Missing response fields | SDK + MCP | - | `requestId`, full `meta`, `latency`, `context` |
| Missing result fields | SDK + MCP | - | `occurredAt`, `entities`, `references`, `highlights`, `vectorSimilarity`, `entityOverlap`, `sameCluster` |
| Missing parameters | SDK + MCP | - | `offset`, `includeContext`, `includeHighlights` (search); `filters` (findSimilar) |
| Missing MCP tools | MCP | 3 tools | 5 tools (`lightfast_graph`, `lightfast_related` undocumented) |
| Missing SDK methods | SDK | 3 methods | 5 methods (`graph()`, `related()` undocumented) |
| Missing error class | SDK | 4 classes | 5 classes (`ServerError` undocumented) |
| Missing constraints | SDK + MCP | - | `limit 1-50` (findSimilar), `1-100` (search), `ids 1-50` (contents) |

### Source of Truth Chain (Working)

```
@repo/console-types (Zod schemas with .describe() and .default())
  |
  v
@repo/console-openapi (generates openapi.json with all metadata)
  |
  v
fumadocs-openapi virtual pages (auto-generated endpoint docs) <-- WORKS
  |
  v  (BROKEN - manual MDX files drift)
SDK docs (typescript-sdk.mdx)
MCP docs (mcp-server.mdx)
```

### Key Discovery: OpenAPI Spec Contains Everything We Need

The generated `openapi.json` (2,265 lines) already contains:
- Field names, types, and nested structures
- `.describe()` text as `description` properties
- `.default()` values as `default` properties
- Validation constraints (min/max, enum values, patterns)
- Required vs optional field markers
- All 10 registered schemas (5 request + 5 response)

**File**: `packages/console-openapi/openapi.json`
**Generated by**: `packages/console-openapi/scripts/generate.ts` via `pnpm --filter @repo/console-openapi generate:openapi`
**Triggered by**: `apps/docs/scripts/generate-api-docs.ts` (prebuild hook)

## Desired End State

After implementation:

1. **SDK and MCP MDX files use `<ParamTable>` and `<ResponseSchema>` components** that read from `openapi.json` at build time
2. **Parameter tables, response interfaces, and enum values auto-update** when Zod schemas change - zero manual intervention
3. **Narrative text, code examples, and guides remain human-written** in MDX
4. **All 5 API methods documented** in both SDK and MCP docs (search, contents, findSimilar, graph, related)
5. **CI validation script** catches any remaining schema references that could drift

### Verification

- `pnpm build:docs` succeeds with no schema reference errors
- All parameter tables in SDK/MCP docs match `openapi.json` exactly
- CI validation script passes: `tsx apps/docs/scripts/validate-schema-docs.ts`
- Manual review confirms narrative quality preserved

## What We're NOT Doing

- **Not replacing fumadocs-openapi virtual pages** - endpoint docs stay auto-generated
- **Not auto-generating entire MDX files** - narrative structure stays human-authored
- **Not auto-generating code examples** - examples require human judgment for DX quality
- **Not adding versioned docs** - single "latest" docs for current alpha
- **Not changing the schema layer** - `@repo/console-types` stays as-is
- **Not modifying the OpenAPI generation pipeline** - existing prebuild hook is sufficient

## Implementation Approach

Create React Server Components that parse `openapi.json` at build time and render parameter tables and response schemas. MDX files replace hardcoded tables with these components, keeping narrative text intact.

**Why OpenAPI-powered components (not direct Zod introspection)?**
- OpenAPI spec already has all metadata extracted cleanly (descriptions, defaults, constraints)
- No complex Zod internal traversal needed (`.describe()` stored in `_def.description`, `.default()` in `_def.defaultValue()`, etc.)
- OpenAPI is a stable, well-documented format
- Already generated during prebuild - zero additional build steps
- Same source powers the virtual endpoint pages

---

## Phase 1: Schema Reader and MDX Components

### Overview
Create the infrastructure: an OpenAPI schema reader utility and reusable MDX components for rendering parameter tables and response schemas.

### Changes Required:

#### 1. OpenAPI Schema Reader
**File**: `apps/docs/src/lib/schema-reader.ts` (NEW)
**Purpose**: Parse `openapi.json` and provide typed access to schema definitions

**Note**: The OpenAPI spec inlines all schemas without `$ref` references, so no reference resolution is needed.

```typescript
import openApiSpec from "../../../packages/console-openapi/openapi.json";

interface SchemaField {
  name: string;
  type: string;          // Human-readable type string
  required: boolean;
  default?: unknown;
  description?: string;
  constraints?: string;  // e.g. "1-100", "min: 0, max: 1"
  enum?: string[];
  children?: SchemaField[]; // For nested objects
}

interface SchemaInfo {
  name: string;
  fields: SchemaField[];
}

/**
 * Extract schema fields from OpenAPI component schema.
 * Handles: primitives, enums, arrays, nested objects.
 */
export function getSchemaFields(schemaName: string): SchemaField[] {
  const schema = openApiSpec.components?.schemas?.[schemaName];
  if (!schema) throw new Error(`Schema "${schemaName}" not found in OpenAPI spec`);
  return parseSchemaProperties(schema);
}

/**
 * Get human-readable type string from OpenAPI schema property.
 */
function resolveType(prop: OpenAPIProperty): string {
  // Handle arrays
  if (prop.type === "array") {
    const itemType = resolveType(prop.items);
    return `${itemType}[]`;
  }
  // Handle enums
  if (prop.enum) return prop.enum.map(v => `"${v}"`).join(" | ");
  // Handle nullable
  if (prop.nullable) return `${prop.type} | null`;
  // Handle oneOf (nullable in OpenAPI 3.1)
  if (prop.oneOf) {
    const types = prop.oneOf.map(s => s.type || resolveType(s));
    return types.join(" | ");
  }
  return prop.type ?? "unknown";
}

function parseConstraints(prop: OpenAPIProperty): string | undefined {
  const parts: string[] = [];
  if (prop.minimum !== undefined) parts.push(`min: ${prop.minimum}`);
  if (prop.maximum !== undefined) parts.push(`max: ${prop.maximum}`);
  if (prop.minItems !== undefined) parts.push(`min items: ${prop.minItems}`);
  if (prop.maxItems !== undefined) parts.push(`max items: ${prop.maxItems}`);
  if (prop.minLength !== undefined) parts.push(`min length: ${prop.minLength}`);
  return parts.length > 0 ? parts.join(", ") : undefined;
}
```

#### 2. ParamTable Component
**File**: `apps/docs/src/components/schema/param-table.tsx` (NEW)
**Purpose**: Render a parameter table from an OpenAPI schema name

```tsx
import { getSchemaFields } from "@/src/lib/schema-reader";

interface ParamTableProps {
  /** OpenAPI schema name (e.g., "V1SearchRequest") */
  schema: string;
  /** Only show these fields (if specified) */
  include?: string[];
  /** Hide these fields */
  exclude?: string[];
  /** Override "Required" column to show "Default" column */
  showDefaults?: boolean;
}

export function ParamTable({ schema, include, exclude, showDefaults = true }: ParamTableProps) {
  const fields = getSchemaFields(schema);
  const filtered = fields
    .filter(f => !include || include.includes(f.name))
    .filter(f => !exclude || !exclude.includes(f.name));

  return (
    <div className="overflow-x-auto">
      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Type</th>
            <th>Required</th>
            {showDefaults && <th>Default</th>}
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          {filtered.map((field) => (
            <tr key={field.name}>
              <td><code>{field.name}</code></td>
              <td><code>{field.type}</code></td>
              <td>{field.required ? "Yes" : "No"}</td>
              {showDefaults && <td>{field.default !== undefined ? <code>{JSON.stringify(field.default)}</code> : "-"}</td>}
              <td>{field.description ?? "-"}{field.constraints ? ` (${field.constraints})` : ""}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

#### 3. ResponseSchema Component
**File**: `apps/docs/src/components/schema/response-schema.tsx` (NEW)
**Purpose**: Render a TypeScript-style interface from an OpenAPI schema

```tsx
import { getSchemaFields, type SchemaField } from "@/src/lib/schema-reader";

interface ResponseSchemaProps {
  /** OpenAPI schema name (e.g., "V1SearchResponse") */
  schema: string;
  /** Custom interface name to display */
  name?: string;
  /** Max depth for nested object expansion */
  depth?: number;
}

export function ResponseSchema({ schema, name, depth = 2 }: ResponseSchemaProps) {
  const fields = getSchemaFields(schema);
  const displayName = name ?? schema;

  return (
    <pre className="language-typescript">
      <code>{renderInterface(displayName, fields, depth)}</code>
    </pre>
  );
}

function renderInterface(name: string, fields: SchemaField[], depth: number, indent = 0): string {
  const pad = "  ".repeat(indent);
  let out = `${pad}interface ${name} {\n`;
  for (const field of fields) {
    const optional = field.required ? "" : "?";
    if (field.children && depth > 0) {
      out += `${pad}  ${field.name}${optional}: {\n`;
      for (const child of field.children) {
        const childOpt = child.required ? "" : "?";
        out += `${pad}    ${child.name}${childOpt}: ${child.type};\n`;
      }
      out += `${pad}  };\n`;
    } else {
      out += `${pad}  ${field.name}${optional}: ${field.type};\n`;
    }
  }
  out += `${pad}}\n`;
  return out;
}
```

#### 4. EnumValues Component
**File**: `apps/docs/src/components/schema/enum-values.tsx` (NEW)
**Purpose**: Render enum values with descriptions for fields like `mode`

```tsx
import { getSchemaFields } from "@/src/lib/schema-reader";

interface EnumValuesProps {
  schema: string;
  field: string;
  descriptions?: Record<string, string>; // Manual descriptions per value
}

export function EnumValues({ schema, field, descriptions }: EnumValuesProps) {
  const fields = getSchemaFields(schema);
  const target = fields.find(f => f.name === field);
  if (!target?.enum) return null;

  return (
    <ul>
      {target.enum.map((value) => (
        <li key={value}>
          <code>"{value}"</code>
          {descriptions?.[value] ? ` - ${descriptions[value]}` : ""}
        </li>
      ))}
    </ul>
  );
}
```

#### 5. Register MDX Components
**File**: `apps/docs/mdx-components.tsx` (EDIT)
**Changes**: Add schema components to the `mdxComponents` export object

**Current pattern**: The file exports a plain object `mdxComponents` that merges fumadocs defaults with custom components.

```typescript
import { ParamTable } from "@/src/components/schema/param-table";
import { ResponseSchema } from "@/src/components/schema/response-schema";
import { EnumValues } from "@/src/components/schema/enum-values";

// Add to the mdxComponents export object (after other custom components like FeatureList, ApiEndpoint, etc.):
export const mdxComponents = {
  ...defaultMdxComponents,
  // ... existing custom components ...
  ParamTable,
  ResponseSchema,
  EnumValues,
};
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `pnpm --filter @lightfast/docs typecheck`
- [ ] Components render without errors in dev: `pnpm dev:docs`
- [ ] `getSchemaFields("V1SearchRequest")` returns correct fields with types, defaults, descriptions
- [ ] `getSchemaFields("V1SearchResponse")` returns correct response structure
- [ ] All 10 registered schemas accessible: V1SearchRequest, V1SearchResponse, V1ContentsRequest, V1ContentsResponse, V1FindSimilarRequest, V1FindSimilarResponse, V1GraphRequest, GraphResponse, V1RelatedRequest, RelatedResponse

#### Manual Verification:
- [ ] `<ParamTable schema="V1SearchRequest" />` renders correct table with all 7 fields
- [ ] Table shows correct types, defaults, required markers, and descriptions
- [ ] `<ResponseSchema schema="V1SearchResponse" />` renders TypeScript-like interface
- [ ] Nested objects render correctly (e.g., `filters.dateRange`, `meta.paths`)

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation from the human that the manual testing was successful before proceeding to the next phase.

---

## Phase 2: Rewrite SDK Documentation

### Overview
Replace all hardcoded parameter tables and response schemas in `typescript-sdk.mdx` with auto-generated components. Fix all drift issues. Add missing methods (graph, related).

### Changes Required:

#### 1. Rewrite typescript-sdk.mdx
**File**: `apps/docs/src/content/api/sdks-tools/typescript-sdk.mdx` (REWRITE)

Key changes:
- Replace hardcoded parameter tables with `<ParamTable schema="..." />`
- Replace hardcoded response interfaces with `<ResponseSchema schema="..." />`
- Fix all drift issues (mode values, filter structure, response names)
- Add `graph()` and `related()` method documentation
- Add `ServerError` to error classes
- Keep all narrative text, code examples, and getting-started guidance

**Example transformation (search parameters):**

Before (hardcoded, drifted):
```markdown
| Property | Type | Required | Default | Description |
|----------|------|----------|---------|-------------|
| `query` | `string` | Yes | - | Natural language search query |
| `limit` | `number` | No | `10` | Number of results to return |
| `mode` | `"fast" \| "balanced" \| "quality"` | No | `"balanced"` | Search mode |
```

After (auto-generated):
```mdx
<ParamTable schema="V1SearchRequest" />
```

**Example transformation (search response):**

Before (hardcoded, drifted):
```markdown
```typescript
interface V1SearchResponse {
  results: V1SearchResult[];
  meta: { total: number; latency: { total: number } };
}
`` `
```

After (auto-generated):
```mdx
<ResponseSchema schema="V1SearchResponse" name="V1SearchResponse" />
```

**New sections to add:**
- `graph()` method with `<ParamTable schema="V1GraphRequest" />` and `<ResponseSchema schema="GraphResponse" />`
- `related()` method with `<ParamTable schema="V1RelatedRequest" />` and `<ResponseSchema schema="RelatedResponse" />`
- `ServerError` class (HTTP 500/502/503/504)

**Narrative sections to update (keep human-written but fix content):**
- Code examples: update to use correct field names (`data` not `results`, `similar` not `results`)
- Filter examples: update to use `sourceTypes` and structured `dateRange`
- Mode descriptions: `"thorough"` not `"quality"`

### Success Criteria:

#### Automated Verification:
- [ ] Docs build succeeds: `pnpm build:docs`
- [ ] No TypeScript errors: `pnpm --filter @lightfast/docs typecheck`
- [ ] All `<ParamTable>` components render with correct field counts:
  - V1SearchRequest: 7 fields (query, limit, offset, mode, filters, includeContext, includeHighlights)
  - V1ContentsRequest: 1 field (ids)
  - V1FindSimilarRequest: 7 fields (id, url, limit, threshold, sameSourceOnly, excludeIds, filters)
  - V1GraphRequest: 3 fields (id, depth, types)
  - V1RelatedRequest: 1 field (id)

#### Manual Verification:
- [ ] SDK docs page renders correctly at `/docs/api-reference/sdks-tools/typescript-sdk`
- [ ] All 5 methods documented: search, contents, findSimilar, graph, related
- [ ] Code examples compile and are accurate
- [ ] Narrative flow reads well (not just tables)
- [ ] All error classes documented including ServerError

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation from the human that the manual testing was successful before proceeding to the next phase.

---

## Phase 3: Rewrite MCP Documentation

### Overview
Replace all hardcoded parameter tables and response schemas in `mcp-server.mdx` with auto-generated components. Fix all drift issues. Add missing tools (graph, related).

### Changes Required:

#### 1. Rewrite mcp-server.mdx
**File**: `apps/docs/src/content/api/sdks-tools/mcp-server.mdx` (REWRITE)

Key changes:
- Replace hardcoded parameter tables with `<ParamTable schema="..." />`
- Replace hardcoded response schemas with `<ResponseSchema schema="..." />`
- Fix all drift issues
- Add `lightfast_graph` and `lightfast_related` tool documentation
- Keep CLI options, environment variables, and usage examples human-written

**New tool sections to add:**
- `lightfast_graph` tool:
  - Description: "Traverse the relationship graph from a starting observation"
  - Parameters: `<ParamTable schema="V1GraphRequest" />`
  - Response: `<ResponseSchema schema="GraphResponse" />`
  - JSON example with graph traversal

- `lightfast_related` tool:
  - Description: "Find observations directly connected to a given observation"
  - Parameters: `<ParamTable schema="V1RelatedRequest" />`
  - Response: `<ResponseSchema schema="RelatedResponse" />`
  - JSON example with related events

**Narrative sections to update:**
- Tool invocation examples: update to use correct response field names
- Mode descriptions in examples: `"thorough"` not `"quality"`
- Filter examples: update to correct structure

### Success Criteria:

#### Automated Verification:
- [ ] Docs build succeeds: `pnpm build:docs`
- [ ] No TypeScript errors: `pnpm --filter @lightfast/docs typecheck`
- [ ] All 5 tools documented with correct parameter counts

#### Manual Verification:
- [ ] MCP docs page renders correctly at `/docs/api-reference/sdks-tools/mcp-server`
- [ ] All 5 tools documented: lightfast_search, lightfast_contents, lightfast_find_similar, lightfast_graph, lightfast_related
- [ ] JSON examples are accurate MCP protocol format
- [ ] CLI options and environment variables section intact

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation from the human that the manual testing was successful before proceeding to the next phase.

---

## Phase 4: CI Validation Script

### Overview
Add a validation script that runs during CI to detect when SDK/MCP docs reference schemas that don't exist in the OpenAPI spec, and to verify all API schemas have corresponding documentation.

### Changes Required:

#### 1. Schema Docs Validation Script
**File**: `apps/docs/scripts/validate-schema-docs.ts` (NEW)
**Purpose**: Validate that all schemas are documented and all references are valid

```typescript
#!/usr/bin/env tsx

import { readFileSync } from "node:fs";
import { resolve } from "node:path";

const openApiPath = resolve(__dirname, "../../../packages/console-openapi/openapi.json");
const sdkMdxPath = resolve(__dirname, "../src/content/api/sdks-tools/typescript-sdk.mdx");
const mcpMdxPath = resolve(__dirname, "../src/content/api/sdks-tools/mcp-server.mdx");

// 1. Load OpenAPI spec and extract schema names
const spec = JSON.parse(readFileSync(openApiPath, "utf-8"));
const schemaNames = Object.keys(spec.components?.schemas ?? {});

// 2. Extract schema references from MDX files
const schemaRefPattern = /schema="([^"]+)"/g;
function extractSchemaRefs(filePath: string): string[] {
  const content = readFileSync(filePath, "utf-8");
  return [...content.matchAll(schemaRefPattern)].map(m => m[1]);
}

// 3. Validate all references exist in OpenAPI spec
const sdkRefs = extractSchemaRefs(sdkMdxPath);
const mcpRefs = extractSchemaRefs(mcpMdxPath);
const allRefs = [...new Set([...sdkRefs, ...mcpRefs])];

let hasErrors = false;

for (const ref of allRefs) {
  if (!schemaNames.includes(ref)) {
    console.error(`ERROR: Schema "${ref}" referenced in docs but not found in OpenAPI spec`);
    hasErrors = true;
  }
}

// 4. Check all request schemas have documentation
const requestSchemas = schemaNames.filter(n => n.includes("Request"));
for (const schema of requestSchemas) {
  if (!allRefs.includes(schema)) {
    console.warn(`WARN: Schema "${schema}" exists in OpenAPI but not referenced in SDK/MCP docs`);
  }
}

if (hasErrors) process.exit(1);
console.log("All schema references valid.");
```

#### 2. Add to Prebuild Hook
**File**: `apps/docs/scripts/generate-api-docs.ts` (EDIT)
**Changes**: Add validation step after OpenAPI generation

```typescript
// After OpenAPI generation succeeds:
console.log("Validating schema documentation references...");
try {
  execSync("tsx scripts/validate-schema-docs.ts", {
    stdio: "inherit",
    cwd: process.cwd(),
  });
  console.log("Schema documentation references valid!");
} catch (error) {
  console.error("Schema documentation validation failed:", error);
  process.exit(1);
}
```

### Success Criteria:

#### Automated Verification:
- [ ] Validation script passes: `tsx apps/docs/scripts/validate-schema-docs.ts`
- [ ] Docs prebuild hook runs validation: `pnpm --filter @lightfast/docs prebuild`
- [ ] Full docs build succeeds: `pnpm build:docs`
- [ ] Introducing a typo in schema name (e.g., `schema="V1SearchRequestt"`) causes build failure

#### Manual Verification:
- [ ] Adding a new schema to `@repo/console-types` and regenerating OpenAPI produces a warning about missing documentation
- [ ] Removing a schema reference from MDX and rebuilding produces no errors (graceful)

---

## Testing Strategy

### Unit Tests:
- `schema-reader.ts`: Test `getSchemaFields()` against known schemas
  - V1SearchRequest should return 7 fields
  - V1ContentsRequest should return 1 field
  - Nested objects (filters, dateRange) should be flattened correctly
  - Enum values should be extracted
  - Default values should be present

### Integration Tests:
- Full docs build: `pnpm build:docs` should succeed
- All MDX pages should render without errors
- Schema components should render HTML tables with correct data

### Manual Testing Steps:
1. Run `pnpm dev:docs` and navigate to `/docs/api-reference/sdks-tools/typescript-sdk`
2. Verify all parameter tables show correct data matching `openapi.json`
3. Change a field description in `packages/console-types/src/api/v1/search.ts`
4. Run `pnpm --filter @repo/console-openapi generate:openapi`
5. Refresh docs dev server and verify the description updated in the parameter table
6. Navigate to `/docs/api-reference/sdks-tools/mcp-server` and verify same
7. Verify all 5 tools/methods are documented in both pages

## Performance Considerations

- `openapi.json` is read once at build time (SSG) - no runtime cost
- Schema parsing is a simple JSON traversal - negligible build time impact
- No additional network requests or API calls
- Virtual pages + schema components means zero MDX file generation

## Migration Notes

- **No data migration needed** - this is a documentation-only change
- **Backward compatible** - existing URLs and page structure unchanged
- **Rollback**: Revert to hardcoded MDX tables if components have issues
- **Incremental**: Can apply to one method at a time within each MDX file

## References

- Research: `thoughts/shared/research/2026-02-12-sdk-mcp-docs-schema-sync.md`
- Schema definitions: `packages/console-types/src/api/v1/` (search.ts, contents.ts, findsimilar.ts, graph.ts)
- OpenAPI registry: `packages/console-openapi/src/registry.ts:1-245`
- OpenAPI generation: `packages/console-openapi/scripts/generate.ts:1-14`
- Docs prebuild: `apps/docs/scripts/generate-api-docs.ts:1-23`
- Source config: `apps/docs/src/lib/source.ts:1-46`
- SDK implementation: `core/lightfast/src/client.ts:1-293`, `core/lightfast/src/types.ts:1-114`
- MCP implementation: `core/mcp/src/server.ts:1-111`
- Current SDK docs: `apps/docs/src/content/api/sdks-tools/typescript-sdk.mdx:1-216`
- Current MCP docs: `apps/docs/src/content/api/sdks-tools/mcp-server.mdx:1-198`
- MDX components: `apps/docs/src/mdx-components.tsx`
- Release workflow: `.github/workflows/release.yml:1-102`
