# fumadocs-openapi Full Migration Implementation Plan

## Overview

Migrate from custom schema documentation components (`ParamTable`, `ResponseSchema`, `EnumValues`) to fumadocs-openapi's built-in rendering. Three outcomes:

1. Auto-generated API reference pages get TypeScript SDK and MCP code samples via `generateCodeSamples`
2. SDK/MCP reference pages use fumadocs-openapi's native schema rendering via a new `EmbeddedOperation` component
3. Custom schema components and `schema-reader.ts` are removed (~230 lines of custom code eliminated)

## Current State Analysis

### What exists now

**Auto-generated pages** at `/docs/api-reference/{operationId}`:
- Generated by fumadocs-openapi v10.3.4 from `packages/console-openapi/openapi.json`
- Custom Lightfast-branded renderers (`api-page-renderers.tsx`)
- Interactive playground enabled with 30s timeout
- **No code samples** — `generateCodeSamples` is not implemented

**Custom components** in `apps/docs/src/components/schema/`:
- `ParamTable` (66 lines) — renders HTML table from OpenAPI schema
- `ResponseSchema` (55 lines) — renders TypeScript interface via SSRCodeBlock
- `EnumValues` (27 lines) — renders enum value list
- `schema-reader.ts` (165 lines) — parses OpenAPI spec into `SchemaField[]`

**Manual MDX pages** using custom components:
- `typescript-sdk.mdx` — 10 component usages (5x `ParamTable` + 5x `ResponseSchema`)
- `mcp-server.mdx` — 10 component usages (5x `ParamTable` + 5x `ResponseSchema`)

### OperationId mapping (from `packages/console-openapi/src/registry.ts`)

| Operation | operationId | Path | SDK Method |
|-----------|------------|------|------------|
| Search | `search` | `/v1/search` | `client.search()` |
| Get Contents | `get-contents` | `/v1/contents` | `client.contents()` |
| Find Similar | `find-similar` | `/v1/findsimilar` | `client.findSimilar()` |
| Graph | `graph` | `/v1/graph` | `client.graph()` |
| Find Related | `find-related` | `/v1/related` | `client.related()` |

## Desired End State

1. Auto-generated API reference pages display TypeScript SDK and MCP tool call code samples in tabs alongside the default cURL/fetch examples
2. SDK and MCP reference pages render parameter tables and response schemas using fumadocs-openapi's native `<Schema>` component (via `EmbeddedOperation`), visually consistent with the auto-generated pages
3. No custom schema parsing or rendering code exists — everything flows through fumadocs-openapi
4. Manual content (installation, config tables, examples, error handling) is preserved in SDK/MCP pages

### How to verify:
- Auto-generated pages at `/docs/api-reference/search` show "TypeScript SDK" and "MCP" tabs in the code samples section
- SDK page at `/docs/api-reference/sdks-tools/typescript-sdk` renders schema tables using fumadocs-openapi styling (collapsible properties, type badges, etc.) instead of custom HTML tables
- MCP page at `/docs/api-reference/sdks-tools/mcp-server` renders schema tables using fumadocs-openapi styling
- No imports from `~/lib/schema-reader` or `~/components/schema/` exist in the codebase
- `pnpm --filter docs build` succeeds with no type errors

## What We're NOT Doing

- Not changing the OpenAPI spec structure or adding `x-codeSamples` to the registry
- Not modifying the OpenAPI generation pipeline (Zod → OpenAPI remains unchanged)
- Not changing URL structure for any pages
- Not removing manual content from SDK/MCP pages (installation, config tables, examples, error classes, type exports)
- Not modifying the auto-generated page renderers (`api-page-renderers.tsx`)
- Not changing the client configuration (`api-page.client.tsx`)
- Not adding dynamic/interactive code sample generation (static strings only)

## Implementation Approach

Use fumadocs-openapi's `createAPIPage` factory twice:
1. **Full `APIPage`** (existing) — for auto-generated `/docs/api-reference/{slug}` pages with playground, header, all sections
2. **Inline `InlineAPIPage`** (new) — minimal renderer for embedding operations in MDX, showing only parameter/response sections without header, playground, or code samples

The `EmbeddedOperation` server component fetches virtual page props from `openapiSource` and renders with the inline variant.

---

## Phase 1: Implement `generateCodeSamples`

### Overview
Add TypeScript SDK and MCP tool call code samples to all 5 auto-generated API reference pages.

### Changes Required:

#### 1. Add code samples callback
**File**: `apps/docs/src/lib/api-page.tsx`
**Changes**: Add `generateCodeSamples` option to `createAPIPage`

```typescript
import { openapi } from "@/src/lib/openapi";
import { createAPIPage } from "fumadocs-openapi/ui";
import client from "./api-page.client";
import { renderOperationLayout, renderPageLayout } from "./api-page-renderers";
import { getCodeSamples } from "./code-samples";

export const APIPage = createAPIPage(openapi, {
  client,
  generateCodeSamples(endpoint) {
    return getCodeSamples(endpoint);
  },
  content: {
    renderOperationLayout,
    renderPageLayout,
  },
});
```

#### 2. Create code samples module
**File**: `apps/docs/src/lib/code-samples.ts` (new)
**Changes**: Define static code samples for each operation

```typescript
import type { MethodInformation } from "fumadocs-openapi/ui";

interface CodeSample {
  id: string;
  lang: string;
  label: string;
  source: string;
}

const sdkSamples: Record<string, string> = {
  search: `import { Lightfast } from "lightfast";

const client = new Lightfast({ apiKey: "sk-lf-..." });

const results = await client.search({
  query: "authentication implementation",
  limit: 10,
  mode: "balanced",
  filters: {
    sourceTypes: ["github"],
  },
});

console.log(results.data);
console.log(results.meta.total);`,

  "get-contents": `import { Lightfast } from "lightfast";

const client = new Lightfast({ apiKey: "sk-lf-..." });

const contents = await client.contents({
  ids: ["obs_abc123", "doc_def456"],
});

console.log(contents.items);
console.log(contents.missing);`,

  "find-similar": `import { Lightfast } from "lightfast";

const client = new Lightfast({ apiKey: "sk-lf-..." });

const similar = await client.findSimilar({
  url: "https://github.com/org/repo/pull/123",
  limit: 5,
  threshold: 0.7,
});

console.log(similar.similar);
console.log(similar.source);`,

  graph: `import { Lightfast } from "lightfast";

const client = new Lightfast({ apiKey: "sk-lf-..." });

const graph = await client.graph({
  id: "obs_abc123",
  depth: 2,
});

console.log(graph.data.nodes);
console.log(graph.data.edges);
console.log(graph.meta.nodeCount);`,

  "find-related": `import { Lightfast } from "lightfast";

const client = new Lightfast({ apiKey: "sk-lf-..." });

const related = await client.related({
  id: "obs_abc123",
});

console.log(related.data.related);
console.log(related.data.bySource);
console.log(related.meta.total);`,
};

const mcpSamples: Record<string, string> = {
  search: `{
  "name": "lightfast_search",
  "arguments": {
    "query": "how does authentication work",
    "limit": 5,
    "mode": "thorough",
    "filters": {
      "sourceTypes": ["github"]
    }
  }
}`,

  "get-contents": `{
  "name": "lightfast_contents",
  "arguments": {
    "ids": ["obs_abc123", "doc_def456"]
  }
}`,

  "find-similar": `{
  "name": "lightfast_find_similar",
  "arguments": {
    "url": "https://github.com/org/repo/pull/123",
    "limit": 5,
    "threshold": 0.7
  }
}`,

  graph: `{
  "name": "lightfast_graph",
  "arguments": {
    "id": "obs_abc123",
    "depth": 2
  }
}`,

  "find-related": `{
  "name": "lightfast_related",
  "arguments": {
    "id": "obs_abc123"
  }
}`,
};

export function getCodeSamples(endpoint: MethodInformation): CodeSample[] {
  const operationId = endpoint.operationId;
  if (!operationId) return [];

  const samples: CodeSample[] = [];

  if (sdkSamples[operationId]) {
    samples.push({
      id: "typescript-sdk",
      lang: "typescript",
      label: "TypeScript SDK",
      source: sdkSamples[operationId],
    });
  }

  if (mcpSamples[operationId]) {
    samples.push({
      id: "mcp-tool-call",
      lang: "json",
      label: "MCP Tool Call",
      source: mcpSamples[operationId],
    });
  }

  return samples;
}
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `pnpm --filter docs typecheck`
- [x] Build succeeds: `pnpm --filter docs build`
- [x] No lint errors: `pnpm --filter docs lint` (pre-existing errors only, no new errors from Phase 1)

#### Manual Verification:
- [ ] Visit `/docs/api-reference/search` — "TypeScript SDK" and "MCP Tool Call" tabs appear in the API example sidebar
- [ ] Visit `/docs/api-reference/get-contents` — code samples render correctly
- [ ] Visit all 5 endpoint pages — each shows relevant SDK and MCP examples
- [ ] Code samples are syntax-highlighted correctly (TypeScript and JSON)
- [ ] Existing playground functionality still works

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation before proceeding to Phase 2.

---

## Phase 2: Create `EmbeddedOperation` Component

### Overview
Create a new `EmbeddedOperation` server component that renders individual fumadocs-openapi operations inline in MDX pages. This replaces `ParamTable` and `ResponseSchema` with fumadocs-openapi's native schema rendering.

### Changes Required:

#### 1. Create inline API page variant
**File**: `apps/docs/src/lib/inline-api-page.tsx` (new)
**Changes**: Second `createAPIPage` instance with minimal renderer

```typescript
import type { ReactNode } from "react";
import { openapi } from "@/src/lib/openapi";
import { createAPIPage } from "fumadocs-openapi/ui";

/**
 * Minimal API page component for embedding operations inline in MDX.
 *
 * Renders only the requested sections (parameters, body, responses)
 * without header, playground, code samples, or branding.
 */
export const InlineAPIPage = createAPIPage(openapi, {
  content: {
    renderOperationLayout(slots) {
      return (
        <div className="not-prose">
          {slots.paremeters}
          {slots.body}
          {slots.responses}
        </div>
      );
    },
    renderPageLayout(slots) {
      return (
        <>
          {slots.operations?.map((op) => (
            <div key={`${op.item.path}:${op.item.method}`}>
              {op.children}
            </div>
          ))}
        </>
      );
    },
  },
  // Disable playground for inline rendering
  playground: {
    enabled: false,
  },
});
```

#### 2. Create EmbeddedOperation component
**File**: `apps/docs/src/components/schema/embedded-operation.tsx` (new)
**Changes**: Server component that fetches operation data and renders inline

```typescript
import { getApiPages } from "@/src/lib/source";
import { InlineAPIPage } from "@/src/lib/inline-api-page";

interface EmbeddedOperationProps {
  /** The operationId from the OpenAPI spec (e.g., "search", "get-contents") */
  operationId: string;
}

/**
 * Renders a fumadocs-openapi operation inline in MDX pages.
 *
 * Uses the same OpenAPI spec and rendering pipeline as the auto-generated
 * API reference pages, but with a minimal layout (no header, no playground).
 *
 * Usage in MDX:
 *   <EmbeddedOperation operationId="search" />
 */
export async function EmbeddedOperation({ operationId }: EmbeddedOperationProps) {
  const pages = getApiPages();

  // Find the virtual page matching this operationId
  // Slugs are based on operationId: ["search"], ["get-contents"], etc.
  const page = pages.find(
    (p) => p.slugs.length === 1 && p.slugs[0] === operationId
  );

  if (!page || !("getAPIPageProps" in page.data)) {
    console.warn(`EmbeddedOperation: No OpenAPI page found for operationId "${operationId}"`);
    return null;
  }

  const props = page.data.getAPIPageProps();

  return (
    <div className="my-6">
      <InlineAPIPage {...props} />
    </div>
  );
}
```

#### 3. Register in MDX components
**File**: `apps/docs/mdx-components.tsx`
**Changes**: Add `EmbeddedOperation` to MDX components, keep old components temporarily

At the imports section (around line 31-33), add:
```typescript
import { EmbeddedOperation } from "@/src/components/schema/embedded-operation";
```

In the `mdxComponents` object (around line 418-420), add:
```typescript
EmbeddedOperation,
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `pnpm --filter docs typecheck`
- [x] Build succeeds: `pnpm --filter docs build`
- [x] No lint errors: `pnpm --filter docs lint` (pre-existing errors only, no new errors from Phase 2)

#### Manual Verification:
- [ ] Create a test MDX page with `<EmbeddedOperation operationId="search" />` and verify it renders the search operation's parameters and response schema using fumadocs-openapi's native UI
- [ ] Verify the embedded operation renders consistently with the auto-generated page at `/docs/api-reference/search` (same schema fields, types, descriptions)
- [ ] Verify all 5 operationIds work: `search`, `get-contents`, `find-similar`, `graph`, `find-related`
- [ ] Verify no playground or header appears in the embedded version

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation before proceeding to Phase 3.

---

## Phase 3: Migrate SDK/MCP MDX Pages

### Overview
Replace all `<ParamTable>` and `<ResponseSchema>` usages with `<EmbeddedOperation>` in both SDK and MCP documentation pages.

### Changes Required:

#### 1. Migrate TypeScript SDK page
**File**: `apps/docs/src/content/api/sdks-tools/typescript-sdk.mdx`

Replace each pair of `<ParamTable>` + `<ResponseSchema>` with a single `<EmbeddedOperation>`:

**search() section** (lines 46, 59):
```mdx
#### SearchInput & Response

<EmbeddedOperation operationId="search" />
```
Removes: `<ParamTable schema="V1SearchRequest" />` and `<ResponseSchema schema="V1SearchResponse" />`

**contents() section** (lines 93, 97):
```mdx
#### ContentsInput & Response

<EmbeddedOperation operationId="get-contents" />
```

**findSimilar() section** (lines 122, 126):
```mdx
#### FindSimilarInput & Response

<EmbeddedOperation operationId="find-similar" />
```

**graph() section** (lines 153, 157):
```mdx
#### GraphInput & Response

<EmbeddedOperation operationId="graph" />
```

**related() section** (lines 184, 188):
```mdx
#### RelatedInput & Response

<EmbeddedOperation operationId="find-related" />
```

**Preserve all manual content**:
- Installation section (lines 10-14)
- LightfastConfig table (lines 26-31)
- SearchFilters table (lines 50-56)
- All example code blocks
- Error Classes section (lines 204-227)
- Type Exports section (lines 230-252)
- Related links (lines 256-261)

#### 2. Migrate MCP Server page
**File**: `apps/docs/src/content/api/sdks-tools/mcp-server.mdx`

Same pattern — replace each pair with `<EmbeddedOperation>`:

**lightfast_search** (lines 49, 78):
```mdx
#### Parameters & Response

<EmbeddedOperation operationId="search" />
```

**lightfast_contents** (lines 88, 102):
```mdx
#### Parameters & Response

<EmbeddedOperation operationId="get-contents" />
```

**lightfast_find_similar** (lines 112, 130):
```mdx
#### Parameters & Response

<EmbeddedOperation operationId="find-similar" />
```

**lightfast_graph** (lines 140, 155):
```mdx
#### Parameters & Response

<EmbeddedOperation operationId="graph" />
```

**lightfast_related** (lines 165, 179):
```mdx
#### Parameters & Response

<EmbeddedOperation operationId="find-related" />
```

**Preserve all manual content**:
- Installation section (lines 10-16)
- CLI Options table (lines 18-30)
- Environment Variables table (lines 32-36)
- Filters object descriptions
- All JSON request examples
- Error Responses section (lines 183-201)
- Related links (lines 204-209)

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `pnpm --filter docs typecheck`
- [x] Build succeeds: `pnpm --filter docs build`
- [x] No lint errors: `pnpm --filter docs lint` (pre-existing errors only, no new errors from Phase 3)
- [x] No references to `<ParamTable` or `<ResponseSchema` in MDX files:
  ```bash
  grep -r "ParamTable\|ResponseSchema" apps/docs/src/content/ --include="*.mdx"
  ```

#### Manual Verification:
- [ ] Visit `/docs/api-reference/sdks-tools/typescript-sdk` — all 5 methods show parameter tables and response schemas using fumadocs-openapi rendering
- [ ] Visit `/docs/api-reference/sdks-tools/mcp-server` — all 5 tools show parameter tables and response schemas
- [ ] Manual content preserved: installation, config tables, examples, error handling, type exports
- [ ] Schema rendering matches the auto-generated API reference pages
- [ ] Page navigation and sidebar work correctly
- [ ] No visual regressions in header/footer/layout

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation before proceeding to Phase 4.

---

## Phase 4: Clean Up Deprecated Components

### Overview
Remove custom schema components that are no longer used.

### Changes Required:

#### 1. Remove custom components
**Delete files**:
- `apps/docs/src/components/schema/param-table.tsx`
- `apps/docs/src/components/schema/response-schema.tsx`
- `apps/docs/src/components/schema/enum-values.tsx`
- `apps/docs/src/lib/schema-reader.ts`

#### 2. Update MDX components registration
**File**: `apps/docs/mdx-components.tsx`

Remove imports (around lines 31-33):
```diff
-import { ParamTable } from "@/src/components/schema/param-table";
-import { ResponseSchema } from "@/src/components/schema/response-schema";
-import { EnumValues } from "@/src/components/schema/enum-values";
```

Remove from `mdxComponents` object (around lines 418-420):
```diff
-  ParamTable,
-  ResponseSchema,
-  EnumValues,
```

Keep:
```typescript
EmbeddedOperation,
```

#### 3. Verify no remaining references
Ensure no imports of deleted modules remain anywhere in the codebase.

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `pnpm --filter docs typecheck`
- [x] Build succeeds: `pnpm --filter docs build`
- [x] No lint errors: `pnpm --filter docs lint` (pre-existing errors only, no new errors from Phase 4)
- [x] No references to deleted files:
  ```bash
  grep -r "schema-reader\|param-table\|response-schema\|enum-values" apps/docs/src/ --include="*.ts" --include="*.tsx" --include="*.mdx"
  ```
- [x] Deleted files no longer exist:
  ```bash
  ls apps/docs/src/components/schema/param-table.tsx 2>/dev/null && echo "FAIL" || echo "OK"
  ls apps/docs/src/components/schema/response-schema.tsx 2>/dev/null && echo "FAIL" || echo "OK"
  ls apps/docs/src/components/schema/enum-values.tsx 2>/dev/null && echo "FAIL" || echo "OK"
  ls apps/docs/src/lib/schema-reader.ts 2>/dev/null && echo "FAIL" || echo "OK"
  ```

#### Manual Verification:
- [ ] All pages still render correctly after cleanup
- [ ] No 500 errors or missing components
- [ ] SDK and MCP pages unchanged from Phase 3

---

## Testing Strategy

### Unit Tests:
- No new unit tests needed (fumadocs-openapi handles schema rendering internally)
- Existing tests (if any) should continue to pass

### Integration Tests:
- Build verification: `pnpm --filter docs build` exercises all MDX pages and server components
- Static generation: `generateStaticParams` in `page.tsx` generates pages for all operations

### Manual Testing Steps:
1. Start dev server: `pnpm dev:docs`
2. Navigate to each auto-generated page and verify code samples appear
3. Navigate to SDK page and verify schema rendering
4. Navigate to MCP page and verify schema rendering
5. Test interactive playground on auto-generated pages
6. Verify all links between pages work

## Performance Considerations

- The `InlineAPIPage` creates a second `createAPIPage` instance — this adds minimal overhead since it uses the same `openapi` server instance (shared schema cache)
- `EmbeddedOperation` calls `getApiPages()` which is already computed during source initialization — no duplicate work
- Removing `schema-reader.ts` eliminates one JSON import of `openapi.json` (the fumadocs-openapi source already imports it)

## Migration Notes

- The visual appearance of schema tables will change from custom HTML tables to fumadocs-openapi's native rendering (collapsible properties, type badges, etc.)
- The separate `ParamTable` + `ResponseSchema` pattern (request params as table, response as TypeScript interface) merges into a single `EmbeddedOperation` showing both parameters and responses in fumadocs-openapi's unified style
- Manual content sections (SearchFilters table, LightfastConfig table, CLI Options) remain as markdown tables since they're not part of the OpenAPI spec

## References

- Research document: `thoughts/shared/research/2026-02-13-fumadocs-openapi-integration.md`
- fumadocs-openapi v10.3.4: `node_modules/.pnpm/fumadocs-openapi@10.3.4_*/`
- OpenAPI registry: `packages/console-openapi/src/registry.ts`
- Custom components: `apps/docs/src/components/schema/`
- API page setup: `apps/docs/src/lib/api-page.tsx`
- Source configuration: `apps/docs/src/lib/source.ts`
